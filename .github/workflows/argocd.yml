name: Deploy to ArgoCD

on:
  workflow_run:
    workflows: ["React.js CICD"]
    types:
      - completed

jobs:
  argocd-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ğŸ› ï¸ Check-out git repository
        uses: actions/checkout@v4

      - name: ğŸ” Check DockerHub for frontend image changes
        id: check-frontend
        run: |
          LATEST_DIGEST=$(docker pull ${{ secrets.DOCKER_USERNAME }}/frontend-js:latest 2>/dev/null | grep "Digest: sha256:" | cut -d ':' -f 3)
          CURRENT_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ secrets.DOCKER_USERNAME }}/frontend-js:latest 2>/dev/null | cut -d '@' -f 2 || echo '')
          if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
            echo "frontend_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Changes detected in DockerHub for frontend."
          else
            echo "frontend_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ”´ No changes detected in DockerHub for frontend."
          fi

      - name: ğŸ” Check DockerHub for backend image changes
        id: check-backend
        run: |
          LATEST_DIGEST=$(docker pull ${{ secrets.DOCKER_USERNAME }}/backend-api:latest 2>/dev/null | grep "Digest: sha256:" | cut -d ':' -f 3)
          CURRENT_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ secrets.DOCKER_USERNAME }}/backend-api:latest 2>/dev/null | cut -d '@' -f 2 || echo '')
          if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
            echo "backend_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Changes detected in DockerHub for backend."
          else
            echo "backend_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ”´ No changes detected in DockerHub for backend."
          fi

      - name: ğŸš€ Sync frontend application with ArgoCD
        if: steps.check-frontend.outputs.frontend_changed == 'true'
        run: |
          echo "ğŸŸ¢ Synchronizing frontend application with ArgoCD..."
          argocd app sync frontend --grpc-web
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}

      - name: ğŸš€ Sync backend application with ArgoCD
        if: steps.check-backend.outputs.backend_changed == 'true'
        run: |
          echo "ğŸŸ¢ Synchronizing backend application with ArgoCD..."
          argocd app sync backend --grpc-web
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}

      - name: ğŸ” Wait for synchronization to complete
        if: steps.check-frontend.outputs.frontend_changed == 'true' || steps.check-backend.outputs.backend_changed == 'true'
        run: |
          echo "ğŸŸ¢ Waiting for ArgoCD synchronization to complete..."
          if [ "${{ steps.check-frontend.outputs.frontend_changed }}" == "true" ]; then
            argocd app wait frontend --timeout 300
          fi
          if [ "${{ steps.check-backend.outputs.backend_changed }}" == "true" ]; then
            argocd app wait backend --timeout 300
          fi
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}

      - name: âœ… Deployment completed
        if: steps.check-frontend.outputs.frontend_changed == 'true' || steps.check-backend.outputs.backend_changed == 'true'
        run: echo "âœ… ArgoCD deployment completed successfully!"

      - name: ğŸ”´ No changes detected
        if: steps.check-frontend.outputs.frontend_changed != 'true' && steps.check-backend.outputs.backend_changed != 'true'
        run: echo "ğŸ”´ No changes detected in either frontend or backend. Skipping ArgoCD sync."