name: Deploy to ArgoCD

on:
  workflow_run:
    workflows: ["React.js CICD"]
    types:
      - completed
  workflow_dispatch:  # ××¤×©×¨×•×ª ×œ×”×¤×¢×œ×” ×™×“× ×™×ª

jobs:
  argocd-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: ğŸ› ï¸ Check-out git repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

      - name: ğŸ” Check ArgoCD Connection
        run: |
          ARGOCD_SERVER=$(echo "${{ secrets.ARGOCD_SERVER }}" | sed 's|^https://https://|https://|')
          ARGOCD_AUTH_TOKEN="${{ secrets.ARGOCD_AUTH_TOKEN }}"
          echo "Checking connection to ArgoCD server: $ARGOCD_SERVER"
          if curl -sSf -k -H "Authorization: Bearer $ARGOCD_AUTH_TOKEN" "$ARGOCD_SERVER/api/v1/applications" > /dev/null; then
            echo "âœ… Successfully connected to ArgoCD server"
          else
            echo "âŒ Failed to connect to ArgoCD server"
            echo "Please check the ARGOCD_SERVER and ARGOCD_AUTH_TOKEN secrets"
            exit 1
          fi

      - name: ğŸ” Check DockerHub for frontend image changes
        id: check-frontend
        run: |
          LATEST_DIGEST=$(docker pull ${{ secrets.DOCKER_USERNAME }}/frontend-js:latest 2>/dev/null | grep "Digest: sha256:" | cut -d ':' -f 3)
          CURRENT_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ secrets.DOCKER_USERNAME }}/frontend-js:latest 2>/dev/null | cut -d '@' -f 2 || echo '')
          if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
            echo "frontend_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Changes detected in DockerHub for frontend image."
          else
            echo "frontend_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ”´ No changes detected in DockerHub for frontend image."
          fi

      - name: ğŸ” Check DockerHub for backend image changes
        id: check-backend
        run: |
          LATEST_DIGEST=$(docker pull ${{ secrets.DOCKER_USERNAME }}/backend-api:latest 2>/dev/null | grep "Digest: sha256:" | cut -d ':' -f 3)
          CURRENT_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ secrets.DOCKER_USERNAME }}/backend-api:latest 2>/dev/null | cut -d '@' -f 2 || echo '')
          if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
            echo "backend_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Changes detected in DockerHub for backend image."
          else
            echo "backend_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ”´ No changes detected in DockerHub for backend image."
          fi

      - name: ğŸš€ Sync quiz application with ArgoCD
        if: steps.check-frontend.outputs.frontend_changed == 'true' || steps.check-backend.outputs.backend_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸŸ¢ Synchronizing quiz application with ArgoCD..."
          ARGOCD_SERVER=$(echo "${{ secrets.ARGOCD_SERVER }}" | sed 's|^https://https://|https://|')
          argocd app sync quiz --server "$ARGOCD_SERVER" --auth-token "${{ secrets.ARGOCD_AUTH_TOKEN }}" --grpc-web --insecure

      - name: ğŸ” Wait for synchronization to complete
        if: steps.check-frontend.outputs.frontend_changed == 'true' || steps.check-backend.outputs.backend_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸŸ¢ Waiting for ArgoCD synchronization to complete..."
          ARGOCD_SERVER=$(echo "${{ secrets.ARGOCD_SERVER }}" | sed 's|^https://https://|https://|')
          argocd app wait quiz --server "$ARGOCD_SERVER" --auth-token "${{ secrets.ARGOCD_AUTH_TOKEN }}" --timeout 300 --insecure

      - name: âœ… Deployment completed
        if: steps.check-frontend.outputs.frontend_changed == 'true' || steps.check-backend.outputs.backend_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: echo "âœ… ArgoCD deployment completed successfully!"

      - name: ğŸ”´ No changes detected
        if: steps.check-frontend.outputs.frontend_changed != 'true' && steps.check-backend.outputs.backend_changed != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "ğŸ”´ No changes detected in frontend or backend images. Skipping ArgoCD sync."